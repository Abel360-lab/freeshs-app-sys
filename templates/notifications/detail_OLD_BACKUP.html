{% extends 'backoffice/base.html' %}
{% load static %}

{% block title %}Notification Details - {{ log.template.name }}{% endblock %}

{% block extra_css %}
<style>
    .detail-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        width: 100%;
        max-width: none;
    }
    
    .container-fluid {
        max-width: 100%;
        padding-left: 15px;
        padding-right: 15px;
    }
    
    .detail-card .row {
        margin-left: 0;
        margin-right: 0;
    }
    
    .detail-card .col-md-6 {
        padding-left: 0;
        padding-right: 0;
    }
    
    .detail-card p {
        margin-bottom: 10px;
        word-wrap: break-word;
    }
    
    .status-badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
    }
    
    .status-sent {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-delivered {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    
    .status-opened {
        background-color: #cce5ff;
        color: #004085;
    }
    
    .status-clicked {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-failed {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .status-bounced {
        background-color: #f5c6cb;
        color: #721c24;
    }
    
    .status-pending {
        background-color: #e2e3e5;
        color: #383d41;
    }
    
    .content-preview {
        max-height: none;
        overflow-y: visible;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        width: 100%;
        max-width: none;
    }
    
    .timeline-item {
        position: relative;
        padding-left: 30px;
        margin-bottom: 20px;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: -20px;
        width: 2px;
        background-color: #dee2e6;
    }
    
    .timeline-item:last-child::before {
        display: none;
    }
    
    .timeline-marker {
        position: absolute;
        left: 6px;
        top: 5px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #007bff;
    }
    
    .timeline-marker.success {
        background-color: #28a745;
    }
    
    .timeline-marker.warning {
        background-color: #ffc107;
    }
    
    .timeline-marker.danger {
        background-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-primary">
                <i class="fas fa-bell"></i> Notification Details
            </h2>
            <p class="text-muted">{{ log.template.name }} - {{ log.recipient_email }}</p>
        </div>
        <div>
            <a href="{% url 'notifications:logs' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Back to Logs
            </a>
        </div>
    </div>
    
    <!-- Main Details -->
            <!-- Basic Information -->
            <div class="detail-card">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-info-circle"></i> Basic Information
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Template:</strong> {{ log.template.name }}</p>
                        <p><strong>Channel:</strong> {{ log.get_channel_display }}</p>
                        <p><strong>Status:</strong> 
                            <span class="status-badge status-{{ log.status|lower }}">
                                {{ log.get_status_display }}
                            </span>
                        </p>
                        <p><strong>Tracking ID:</strong> 
                            {% if log.tracking_id %}
                                <code>{{ log.tracking_id }}</code>
                            {% else %}
                                <span class="text-muted">Not available</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Recipient Email:</strong> {{ log.recipient_email }}</p>
                        <p><strong>Recipient Name:</strong> 
                            {% if log.recipient_name %}{{ log.recipient_name }}{% else %}<span class="text-muted">Not provided</span>{% endif %}
                        </p>
                        <p><strong>External ID:</strong> 
                            {% if log.external_id %}<code>{{ log.external_id }}</code>{% else %}<span class="text-muted">Not available</span>{% endif %}
                        </p>
                        <p><strong>Retry Count:</strong> {{ log.retry_count }}/{{ log.max_retries }}</p>
                    </div>
                </div>
            </div>
            
            <!-- Content -->
            <div class="detail-card">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-file-text"></i> Content
                </h5>
                <p><strong>Subject:</strong> {{ log.subject }}</p>
                
                {% if log.body_html %}
                <div class="mb-3">
                    <strong>HTML Body:</strong>
                    <div class="content-preview">
                        {{ log.body_html|safe }}
                    </div>
                </div>
                {% endif %}
                
                {% if log.body_text %}
                <div class="mb-3">
                    <strong>Text Body:</strong>
                    <div class="content-preview">
                        <pre>{{ log.body_text }}</pre>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Error Information -->
            {% if log.error_message %}
            <div class="detail-card">
                <h5 class="text-danger mb-3">
                    <i class="fas fa-exclamation-triangle"></i> Error Information
                </h5>
                <div class="alert alert-danger">
                    <strong>Error Message:</strong><br>
                    {{ log.error_message }}
                </div>
            </div>
            {% endif %}
            
            <!-- Context Data -->
            {% if log.context_data %}
            <div class="detail-card">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-database"></i> Context Data
                </h5>
                <div class="content-preview">
                    <pre>{{ log.context_data|pprint }}</pre>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Timeline -->
            <div class="detail-card">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-clock"></i> Timeline
                </h5>
                
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div>
                        <strong>Created</strong>
                        <br>
                        <small class="text-muted">{{ log.created_at|date:"M d, Y H:i:s" }}</small>
                    </div>
                </div>
                
                {% if log.sent_at %}
                <div class="timeline-item">
                    <div class="timeline-marker success"></div>
                    <div>
                        <strong>Sent</strong>
                        <br>
                        <small class="text-muted">{{ log.sent_at|date:"M d, Y H:i:s" }}</small>
                    </div>
                </div>
                {% endif %}
                
                {% if log.delivered_at %}
                <div class="timeline-item">
                    <div class="timeline-marker success"></div>
                    <div>
                        <strong>Delivered</strong>
                        <br>
                        <small class="text-muted">{{ log.delivered_at|date:"M d, Y H:i:s" }}</small>
                    </div>
                </div>
                {% endif %}
                
                {% if log.opened_at %}
                <div class="timeline-item">
                    <div class="timeline-marker warning"></div>
                    <div>
                        <strong>Opened</strong>
                        <br>
                        <small class="text-muted">{{ log.opened_at|date:"M d, Y H:i:s" }}</small>
                    </div>
                </div>
                {% endif %}
                
                {% if log.clicked_at %}
                <div class="timeline-item">
                    <div class="timeline-marker warning"></div>
                    <div>
                        <strong>Clicked</strong>
                        <br>
                        <small class="text-muted">{{ log.clicked_at|date:"M d, Y H:i:s" }}</small>
                    </div>
                </div>
                {% endif %}
                
                {% if log.status == 'FAILED' %}
                <div class="timeline-item">
                    <div class="timeline-marker danger"></div>
                    <div>
                        <strong>Failed</strong>
                        <br>
                        <small class="text-muted">{{ log.updated_at|date:"M d, Y H:i:s" }}</small>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Related Objects -->
            <div class="detail-card">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-link"></i> Related Objects
                </h5>
                
                {% if log.application %}
                <div class="mb-3">
                    <strong>Application:</strong><br>
                    <a href="{% url 'applications:backoffice-application-detail' log.application.pk %}" class="btn btn-sm btn-outline-info">
                        <i class="fas fa-file-alt"></i> {{ log.application.tracking_code }}
                    </a>
                </div>
                {% endif %}
                
                {% if log.user %}
                <div class="mb-3">
                    <strong>User:</strong><br>
                    <span class="badge bg-success">
                        <i class="fas fa-user"></i> {{ log.user.get_full_name|default:log.user.username }}
                    </span>
                </div>
                {% endif %}
                
                {% if log.tracking_id %}
                <div class="mb-3">
                    <strong>Tracking URLs:</strong><br>
                    <a href="{{ log.get_tracking_url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                        <i class="fas fa-link"></i> Track
                    </a>
                    <a href="{{ log.get_open_tracking_url }}" class="btn btn-sm btn-outline-info" target="_blank">
                        <i class="fas fa-eye"></i> Open Track
                    </a>
                </div>
                {% endif %}
            </div>
            
            <!-- Performance Metrics -->
            <div class="detail-card">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-chart-line"></i> Performance
                </h5>
                
                {% if log.delivery_time %}
                <p><strong>Delivery Time:</strong> {{ log.delivery_time|floatformat:2 }} seconds</p>
                {% endif %}
                
                <p><strong>Success Status:</strong> 
                    {% if log.is_successful %}
                        <span class="text-success"><i class="fas fa-check"></i> Yes</span>
                    {% else %}
                        <span class="text-danger"><i class="fas fa-times"></i> No</span>
                    {% endif %}
                </p>
                
                <p><strong>Failed Status:</strong> 
                    {% if log.is_failed %}
                        <span class="text-danger"><i class="fas fa-times"></i> Yes</span>
                    {% else %}
                        <span class="text-success"><i class="fas fa-check"></i> No</span>
                    {% endif %}
                </p>
            </div>
            
            <!-- Actions -->
            <div class="detail-card">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-cogs"></i> Actions
                </h5>
                
                {% if log.status == 'FAILED' and log.can_retry %}
                <button class="btn btn-warning btn-sm mb-2" onclick="retryNotification({{ log.id }})">
                    <i class="fas fa-redo"></i> Retry Notification
                </button>
                {% endif %}
                
                <a href="{% url 'notifications:logs' %}?search={{ log.recipient_email }}" class="btn btn-outline-primary btn-sm mb-2">
                    <i class="fas fa-search"></i> Find Similar
                </a>
                
                <button class="btn btn-outline-info btn-sm mb-2" onclick="copyToClipboard('{{ log.tracking_id }}')">
                    <i class="fas fa-copy"></i> Copy Tracking ID
                </button>
            </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function retryNotification(notificationId) {
    if (confirm('Are you sure you want to retry this notification?')) {
        fetch('{% url "notifications:retry-failed" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'notification_ids=' + notificationId
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while retrying the notification.');
        });
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        alert('Tracking ID copied to clipboard!');
    }, function(err) {
        console.error('Could not copy text: ', err);
        alert('Failed to copy tracking ID');
    });
}
</script>
{% endblock %}
