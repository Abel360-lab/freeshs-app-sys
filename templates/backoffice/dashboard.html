{% extends "backoffice/base.html" %}
{% load static %}

{% block title %}Dashboard - GCX Admin Portal{% endblock %}

{% block page_icon %}<i class="fas fa-tachometer-alt"></i>{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Real-time overview of supplier applications and system performance{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item active">Dashboard</li>
    </ol>
</nav>
{% endblock %}

{% block page_actions %}
<button class="btn btn-outline-primary btn-sm" onclick="refreshDashboard()">
    <i class="fas fa-sync-alt"></i> Refresh
</button>
<button class="btn btn-primary btn-sm" onclick="exportDashboard()">
    <i class="fas fa-download"></i> Export Report
</button>
{% endblock %}

{% block content %}
<!-- Welcome Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="welcome-banner" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%); border-radius: var(--border-radius); padding: 2rem; color: white; margin-bottom: 2rem;">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 style="margin: 0; font-weight: 600;">Welcome back, {{ user.get_full_name|default:user.username }}!</h2>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Here's what's happening with your supplier applications today.</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div style="font-size: 0.875rem; opacity: 0.85;">
                        <i class="fas fa-calendar-alt me-2"></i>{{ today|date:"l, F j, Y" }}
                    </div>
                    <div style="font-size: 0.875rem; opacity: 0.85; margin-top: 0.5rem;">
                        <i class="fas fa-clock me-2"></i><span id="current-time">--:--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card">
            <i class="fas fa-file-alt stat-icon"></i>
            <div class="stat-value">{{ total_applications|default:"0" }}</div>
            <div class="stat-label">Total Applications</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i> 
                <span>+{{ new_this_week|default:"0" }}</span>
                <small>this week</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card warning">
            <i class="fas fa-hourglass-half stat-icon"></i>
            <div class="stat-value">
                {% for status in status_counts %}
                    {% if status.status == 'PENDING_REVIEW' %}{{ status.count }}{% endif %}
                {% empty %}0{% endfor %}
            </div>
            <div class="stat-label">Pending Review</div>
            <div class="stat-change">
                <i class="fas fa-clock"></i>
                <span>Awaiting action</span>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card success">
            <i class="fas fa-check-circle stat-icon"></i>
            <div class="stat-value">
                {% for status in status_counts %}
                    {% if status.status == 'APPROVED' %}{{ status.count }}{% endif %}
                {% empty %}0{% endfor %}
            </div>
            <div class="stat-label">Approved Suppliers</div>
            <div class="stat-change positive">
                <i class="fas fa-trophy"></i>
                <span>Active</span>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card info">
            <i class="fas fa-folder-open stat-icon"></i>
            <div class="stat-value">
                {% for status in status_counts %}
                    {% if status.status == 'UNDER_REVIEW' %}{{ status.count }}{% endif %}
                {% empty %}0{% endfor %}
            </div>
            <div class="stat-label">Under Review</div>
            <div class="stat-change">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Action required</span>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Panel -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" style="background: linear-gradient(135deg, rgba(30, 58, 95, 0.03) 0%, rgba(30, 58, 95, 0.01) 100%);">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-bolt text-warning"></i>
                    Quick Actions
                </h5>
                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-2">
                        <a href="{% url 'applications:backoffice-applications' %}?status=pending" 
                           class="quick-action-btn d-flex align-items-center p-3 text-decoration-none"
                           style="background: white; border: 2px solid var(--warning-color); border-radius: var(--border-radius-sm); transition: var(--transition);">
                            <div class="flex-shrink-0">
                                <div style="width: 45px; height: 45px; background: rgba(255, 193, 7, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-clock" style="color: var(--warning-color); font-size: 1.25rem;"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0" style="color: var(--text-color); font-weight: 600;">Review Pending</h6>
                                <small class="text-muted">{{ pending_count|default:"0" }} applications</small>
                            </div>
                            <i class="fas fa-arrow-right" style="color: var(--warning-color);"></i>
                        </a>
                    </div>
                    
                    <div class="col-md-3 col-sm-6 mb-2">
                        <a href="{% url 'applications:backoffice-documents' %}" 
                           class="quick-action-btn d-flex align-items-center p-3 text-decoration-none"
                           style="background: white; border: 2px solid var(--info-color); border-radius: var(--border-radius-sm); transition: var(--transition);">
                            <div class="flex-shrink-0">
                                <div style="width: 45px; height: 45px; background: rgba(23, 162, 184, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-check-circle" style="color: var(--info-color); font-size: 1.25rem;"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0" style="color: var(--text-color); font-weight: 600;">Verify Documents</h6>
                                <small class="text-muted">{{ docs_pending|default:"0" }} pending</small>
                            </div>
                            <i class="fas fa-arrow-right" style="color: var(--info-color);"></i>
                        </a>
                    </div>
                    
                    <div class="col-md-3 col-sm-6 mb-2">
                        <a href="{% url 'applications:backoffice-suppliers' %}" 
                           class="quick-action-btn d-flex align-items-center p-3 text-decoration-none"
                           style="background: white; border: 2px solid var(--accent-color); border-radius: var(--border-radius-sm); transition: var(--transition);">
                            <div class="flex-shrink-0">
                                <div style="width: 45px; height: 45px; background: rgba(40, 167, 69, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-users" style="color: var(--accent-color); font-size: 1.25rem;"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0" style="color: var(--text-color); font-weight: 600;">Active Suppliers</h6>
                                <small class="text-muted">{{ active_suppliers|default:"0" }} total</small>
                            </div>
                            <i class="fas fa-arrow-right" style="color: var(--accent-color);"></i>
                        </a>
                    </div>
                    
                    <div class="col-md-3 col-sm-6 mb-2">
                        <a href="{% url 'applications:backoffice-analytics' %}" 
                           class="quick-action-btn d-flex align-items-center p-3 text-decoration-none"
                           style="background: white; border: 2px solid var(--primary-color); border-radius: var(--border-radius-sm); transition: var(--transition);">
                            <div class="flex-shrink-0">
                                <div style="width: 45px; height: 45px; background: rgba(30, 58, 95, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-chart-line" style="color: var(--primary-color); font-size: 1.25rem;"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0" style="color: var(--text-color); font-weight: 600;">View Analytics</h6>
                                <small class="text-muted">Full reports</small>
                            </div>
                            <i class="fas fa-arrow-right" style="color: var(--primary-color);"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Row -->
<div class="row mb-4">
    <!-- Trends Chart -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-chart-line"></i>
                    Application Trends
                </h5>
                <div class="card-actions">
                    <select class="form-select form-select-sm" style="width: auto;" onchange="updateTrendsChart(this.value)">
                        <option value="6">Last 6 Months</option>
                        <option value="3">Last 3 Months</option>
                        <option value="12">Last Year</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div id="trendsChart"></div>
            </div>
        </div>
    </div>
    
    <!-- Status Distribution -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">
                    <i class="fas fa-chart-pie"></i>
                    Status Distribution
                </h5>
                <div class="d-flex align-items-center">
                    <span id="connection-status" class="me-2">
                        <i class="fas fa-circle text-success"></i> Connected
                    </span>
                    <button id="refresh-dashboard" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="statusChart"></div>
            </div>
        </div>
    </div>
</div>

<!-- Data Tables Row -->
<div class="row">
    <!-- Recent Applications -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-history"></i>
                    Recent Applications
                </h5>
                <div class="card-actions">
                    <a href="{% url 'applications:backoffice-applications' %}" class="btn btn-primary btn-sm">
                        View All <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if recent_applications %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Business</th>
                                <th>Region</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for app in recent_applications|slice:":5" %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                                {{ app.business_name|first|upper }}
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6 class="mb-0" style="font-weight: 600;">{{ app.business_name|truncatechars:25 }}</h6>
                                            <small class="text-muted">{{ app.tracking_code }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ app.region.name|default:"--" }}</td>
                                <td>
                                    <span class="badge badge-status badge-{{ app.status }}">
                                        {{ app.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    <small>{{ app.created_at|date:"M d, Y" }}</small>
                                </td>
                                <td>
                                    <a href="{% url 'applications:backoffice-application-detail' app.pk %}" 
                                       class="btn btn-icon btn-sm btn-outline-primary"
                                       data-bs-toggle="tooltip" 
                                       title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No recent applications</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Regional Distribution -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-map-marked-alt"></i>
                    Regional Distribution
                </h5>
            </div>
            <div class="card-body">
                <div id="regionalChart"></div>
                {% if region_stats %}
                <div class="mt-3" style="max-height: 200px; overflow-y: auto;">
                    {% for region in region_stats|slice:":5" %}
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: var(--background-light); border-radius: var(--border-radius-sm);">
                        <div class="d-flex align-items-center">
                            <div style="width: 8px; height: 8px; background: var(--primary-color); border-radius: 50%; margin-right: 0.5rem;"></div>
                            <span style="font-size: 0.875rem;">{{ region.region__name|default:"Unknown" }}</span>
                        </div>
                        <strong style="font-size: 0.875rem;">{{ region.count }}</strong>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Activity Feed -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-stream"></i>
                    Recent Activity
                </h5>
                <div class="card-actions">
                    <button class="btn btn-outline-primary btn-sm" onclick="loadMoreActivity()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="activity-feed">
                    <div class="activity-item">
                        <div class="activity-icon" style="background: rgba(40, 167, 69, 0.15); color: var(--accent-color);">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="activity-content">
                            <p><strong>New application approved</strong></p>
                            <small class="text-muted">ABC Trading Ltd. - 5 minutes ago</small>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon" style="background: rgba(255, 193, 7, 0.15); color: var(--warning-color);">
                            <i class="fas fa-file-upload"></i>
                        </div>
                        <div class="activity-content">
                            <p><strong>Documents uploaded</strong></p>
                            <small class="text-muted">XYZ Suppliers - 15 minutes ago</small>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon" style="background: rgba(23, 162, 184, 0.15); color: var(--info-color);">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="activity-content">
                            <p><strong>New application received</strong></p>
                            <small class="text-muted">Global Commodities - 1 hour ago</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .quick-action-btn:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-md) !important;
    }
    
    
    .activity-feed {
        position: relative;
        padding-left: 3rem;
    }
    
    .activity-feed::before {
        content: '';
        position: absolute;
        left: 1.25rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--background-light);
    }
    
    .activity-item {
        position: relative;
        margin-bottom: 1.5rem;
    }
    
    .activity-icon {
        position: absolute;
        left: -2rem;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border: 2px solid white;
    }
    
    .activity-content p {
        margin: 0;
        font-size: 0.95rem;
    }
    
    /* Chart container fixes */
    #trendsChart, #statusChart, #regionalChart {
        min-height: 200px;
        width: 100%;
    }
    
    #statusChart {
        min-height: 250px;
    }
    
    #trendsChart {
        min-height: 350px;
    }
</style>
{% endblock %}

{% block extrajs %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="{% static 'js/realtime-dashboard.js' %}"></script>
<script>
// Chart instances for global access
let trendsChart, statusChart, regionalChart;

// Function to check if element is visible
function isElementVisible(element) {
    if (!element) return false;
    const rect = element.getBoundingClientRect();
    return rect.width > 0 && rect.height > 0;
}

// Function to initialize all charts
function initializeCharts() {
    // Destroy existing charts first to prevent duplicates
    destroyCharts();
    
    // Prevent multiple initializations
    if (trendsChart && statusChart && regionalChart) {
        return;
    }
    
    // Wait for containers to be visible and have dimensions
    const checkAndInit = () => {
        const trendsElement = document.querySelector("#trendsChart");
        const statusElement = document.querySelector("#statusChart");
        const regionalElement = document.querySelector("#regionalChart");
        
        if (isElementVisible(trendsElement) && isElementVisible(statusElement) && isElementVisible(regionalElement)) {
        // Trends Chart
        const trendsOptions = {
            series: [{
                name: 'Applications',
                data: {{ monthly_data|default:"[0,0,0,0,0,0]"|safe }}
            }],
            chart: {
                type: 'area',
                height: 350,
                toolbar: {
                    show: false
                },
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 800
                }
            },
            colors: ['#1e3a5f'],
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'smooth',
                width: 3
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shadeIntensity: 1,
                    opacityFrom: 0.4,
                    opacityTo: 0.1,
                    stops: [0, 90, 100]
                }
            },
            xaxis: {
                categories: {{ monthly_labels|default:"['Jan','Feb','Mar','Apr','May','Jun']"|safe }}
            },
            yaxis: {
                title: {
                    text: 'Applications'
                }
            },
            tooltip: {
                x: {
                    format: 'MMM yyyy'
                }
            }
        };
        
        if (document.querySelector("#trendsChart") && !trendsChart) {
            trendsChart = new ApexCharts(document.querySelector("#trendsChart"), trendsOptions);
            trendsChart.render();
        }
        
        // Status Distribution Chart
        const statusOptions = {
            series: [
                {{ pending_count|default:"0" }},
                {{ approved_count|default:"0" }},
                {{ review_count|default:"0" }},
                {{ rejected_count|default:"0" }}
            ],
            chart: {
                type: 'donut',
                height: 250,
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 800
                }
            },
            labels: ['Pending Review', 'Approved', 'Under Review', 'Rejected'],
            colors: ['#ffc107', '#28a745', '#17a2b8', '#dc3545'],
            dataLabels: {
                enabled: false
            },
            plotOptions: {
                pie: {
                    donut: {
                        size: '70%',
                        labels: {
                            show: true,
                            total: {
                                show: true,
                                label: 'Total',
                                formatter: function (w) {
                                    return w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                }
                            }
                        }
                    }
                }
            },
            legend: {
                show: false
            }
        };
        
        if (document.querySelector("#statusChart") && !statusChart) {
            statusChart = new ApexCharts(document.querySelector("#statusChart"), statusOptions);
            statusChart.render();
            // Store chart reference for real-time updates
            document.querySelector("#statusChart")._chart = statusChart;
        }
        
        // Regional Chart
        const regionalOptions = {
            series: [{
                data: {{ region_data|default:"[0,0,0,0,0]"|safe }}
            }],
            chart: {
                type: 'bar',
                height: 200,
                toolbar: {
                    show: false
                },
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 800
                }
            },
            plotOptions: {
                bar: {
                    horizontal: true,
                    borderRadius: 4,
                    distributed: true
                }
            },
            colors: ['#1e3a5f', '#2c4f7c', '#3498db', '#5dade2', '#85c1e2'],
            dataLabels: {
                enabled: false
            },
            xaxis: {
                categories: {{ region_labels|default:"['Region 1','Region 2','Region 3','Region 4','Region 5']"|safe }}
            },
            yaxis: {
                show: false
            },
            grid: {
                show: false
            },
            tooltip: {
                y: {
                    title: {
                        formatter: function() {
                            return 'Applications:'
                        }
                    }
                }
            }
        };
        
        if (document.querySelector("#regionalChart") && !regionalChart) {
            regionalChart = new ApexCharts(document.querySelector("#regionalChart"), regionalOptions);
            regionalChart.render();
        }
        } else {
            // If elements are not visible yet, try again in 100ms
            setTimeout(checkAndInit, 100);
        }
    };
    
    // Start the check
    checkAndInit();
}

// Function to destroy existing charts
function destroyCharts() {
    if (trendsChart) {
        trendsChart.destroy();
        trendsChart = null;
    }
    if (statusChart) {
        statusChart.destroy();
        statusChart = null;
    }
    if (regionalChart) {
        regionalChart.destroy();
        regionalChart = null;
    }
}

// Function to resize charts
function resizeCharts() {
    if (trendsChart) trendsChart.resize();
    if (statusChart) statusChart.resize();
    if (regionalChart) regionalChart.resize();
}

document.addEventListener('DOMContentLoaded', function() {
    // Update current time
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        const timeElement = document.getElementById('current-time');
        if (timeElement) {
            timeElement.textContent = timeString;
        }
    }
    updateTime();
    setInterval(updateTime, 60000);
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
    
    // Initialize charts
    initializeCharts();
    
    // Add resize event listener
    window.addEventListener('resize', resizeCharts);
    
    // Fallback: Initialize charts on window load if not already done
    window.addEventListener('load', () => {
        if (!trendsChart || !statusChart || !regionalChart) {
            initializeCharts();
        }
    });
});

// Dashboard functions
function refreshDashboard() {
    location.reload();
}

function exportDashboard() {
    window.print();
}

function updateTrendsChart(months) {
    // This would typically make an AJAX call to get new data
    console.log('Updating chart for ' + months + ' months');
}

function loadMoreActivity() {
    // This would typically load more activity items via AJAX
    console.log('Loading more activity...');
}
</script>
{% endblock %}