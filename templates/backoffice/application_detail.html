{% extends 'backoffice/base.html' %}
{% load static %}

{% block title %}{{ application.business_name }} - Application Details{% endblock %}

{% block page_header_container %}
<div class="page-header-container">
    <div class="page-header-content">
        <div class="page-header-info">
            <div class="page-header-breadcrumb">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'applications:backoffice-dashboard' %}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'applications:backoffice-applications' %}">Applications</a></li>
                        <li class="breadcrumb-item active">{{ application.tracking_code }}</li>
                    </ol>
                </nav>
            </div>
            <h1 class="page-header-title">{{ application.business_name }}</h1>
            <p class="page-header-subtitle">
                {{ application.tracking_code }} â€¢ Submitted {{ application.created_at|date:"F d, Y" }}
            </p>
        </div>
        <div class="page-header-actions">
            <button class="btn btn-outline-secondary" onclick="window.print()">
                <i class="fas fa-print"></i> Print
            </button>
            <a href="{% url 'applications:backoffice-application-pdf' application.pk %}" class="btn btn-outline-secondary" target="_blank">
                <i class="fas fa-file-pdf"></i> Download PDF
            </a>
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-cog"></i> Actions
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    {% if can_approve %}
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#approveModal">
                        <i class="fas fa-check text-success me-2"></i>Approve Application
                    </a></li>
                    {% endif %}
                    {% if can_reject %}
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#rejectModal">
                        <i class="fas fa-times text-danger me-2"></i>Reject Application
                    </a></li>
                    {% endif %}
                    {% if application.status == 'APPROVED' %}
                    <li><a class="dropdown-item" href="{% url 'applications:backoffice-award-contract' application.pk %}">
                        <i class="fas fa-award text-primary me-2"></i>Award Contract
                    </a></li>
                    {% endif %}
                    {% if should_show_request_docs %}
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="requestDocuments(); return false;">
                        <i class="fas fa-file-upload text-warning me-2"></i>Request Missing Documents
                        {% if missing_documents %}
                        <span class="badge bg-danger ms-2">{{ missing_documents|length }}</span>
                        {% endif %}
                    </a></li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{% url 'applications:backoffice-download-pack' application.pk %}">
                        <i class="fas fa-download text-info me-2"></i>Download Pack
                        <small class="d-block text-muted ms-4">All documents + PDF</small>
                    </a></li>
                    <li><a class="dropdown-item" href="mailto:{{ application.email }}">
                        <i class="fas fa-envelope me-2"></i>Send Email
                    </a></li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<form style="display: none;" id="csrf-form">{% csrf_token %}</form>

<style>
/* Enhanced Application Detail Page Styles */

/* Status Banner */
.status-banner {
    background: #ffffff;
    border: 1.5px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1.25rem;
    flex-wrap: wrap;
}

.status-banner-left {
    display: flex;
    align-items: center;
    gap: 1.25rem;
}

.status-icon-large {
    width: 56px;
    height: 56px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.status-content h3 {
    font-size: 1.125rem;
    font-weight: 700;
    color: #111827;
    margin: 0 0 0.25rem 0;
}

.status-content p {
    font-size: 0.8125rem;
    color: #6b7280;
    margin: 0;
}

.status-badge-xl {
    padding: 0.625rem 1.25rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    white-space: nowrap;
}

.status-badge-xl.pending {
    background: #fef3c7;
    color: #92400e;
}

.status-badge-xl.review {
    background: #dbeafe;
    color: #1e40af;
}

.status-badge-xl.approved {
    background: #dcfce7;
    color: #166534;
}

.status-badge-xl.rejected {
    background: #fee2e2;
    color: #991b1b;
}

/* Modern Card */
.modern-info-card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 1.25rem;
}

.modern-info-card:last-child {
    margin-bottom: 0;
}

.modern-card-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #e5e7eb;
    background: #f9fafb;
}

.modern-card-title {
    font-size: 1.0625rem;
    font-weight: 600;
    color: #111827;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.625rem;
}

.modern-card-title i {
    width: 24px;
    text-align: center;
}

.modern-card-body {
    padding: 1rem 1.25rem;
}

/* Info Row */
.detail-info-row {
    display: grid;
    grid-template-columns: 180px 1fr;
    gap: 1rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f3f4f6;
}

.detail-info-row:first-child {
    padding-top: 0;
}

.detail-info-row:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.detail-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #6b7280;
}

.detail-value {
    font-size: 0.875rem;
    color: #111827;
    font-weight: 500;
}

.detail-value strong {
    color: #111827;
}

/* Commodity Badges */
.commodity-badge-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.625rem;
}

.commodity-badge {
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #eff6ff, #dbeafe);
    border: 1px solid #bfdbfe;
    color: #1e40af;
    border-radius: 8px;
    font-size: 0.8125rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

/* Team Member Cards */
.member-card {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 0.875rem;
    transition: all 0.2s ease;
}

.member-card:last-child {
    margin-bottom: 0;
}

.member-card:hover {
    border-color: #d1d5db;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.member-header {
    display: flex;
    align-items: center;
    gap: 0.875rem;
    margin-bottom: 0.875rem;
    padding-bottom: 0.875rem;
    border-bottom: 1px solid #e5e7eb;
}

.member-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
    color: #ffffff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.125rem;
    flex-shrink: 0;
}

.member-info h6 {
    font-size: 0.9375rem;
    font-weight: 600;
    color: #111827;
    margin: 0 0 0.25rem 0;
}

.member-info small {
    font-size: 0.8125rem;
    color: #6b7280;
}

.member-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 0.875rem;
}

.member-detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.member-detail-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.member-detail-value {
    font-size: 0.875rem;
    color: #111827;
    font-weight: 500;
}

/* Document Items */
.doc-item {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 0.875rem 1rem;
    margin-bottom: 0.625rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    transition: all 0.2s ease;
    flex-wrap: wrap;
}

.doc-item:last-child {
    margin-bottom: 0;
}

.doc-item:hover {
    border-color: var(--primary-color);
    transform: translateX(4px);
}

.doc-item-left {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
    min-width: 0;
}

.doc-item-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
}

.doc-item-info {
    flex: 1;
    min-width: 0;
}

.doc-item-info h6 {
    font-size: 0.875rem;
    font-weight: 600;
    color: #111827;
    margin: 0 0 0.125rem 0;
}

.doc-item-info small {
    font-size: 0.75rem;
    color: #6b7280;
    display: block;
}

.doc-status-pill {
    padding: 0.375rem 0.875rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    white-space: nowrap;
    flex-shrink: 0;
}

.doc-status-pill.verified {
    background: #dcfce7;
    color: #166534;
}

.doc-status-pill.uploaded {
    background: #dbeafe;
    color: #1e40af;
}

.doc-status-pill.missing {
    background: #fee2e2;
    color: #991b1b;
}

.doc-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
    flex-shrink: 0;
}

/* Timeline */
.timeline-enhanced {
    position: relative;
    padding-left: 2.5rem;
}

.timeline-enhanced::before {
    content: '';
    position: absolute;
    left: 0.75rem;
    top: 0.5rem;
    bottom: 0.5rem;
    width: 2px;
    background: linear-gradient(180deg, var(--primary-color), #e5e7eb);
}

.timeline-item-enhanced {
    position: relative;
    margin-bottom: 1.25rem;
}

.timeline-item-enhanced:last-child {
    margin-bottom: 0;
}

.timeline-dot {
    position: absolute;
    left: -2.5rem;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    border: 2px solid #ffffff;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.timeline-card {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.875rem 1rem;
}

.timeline-card h6 {
    font-size: 0.9375rem;
    font-weight: 600;
    color: #111827;
    margin: 0 0 0.25rem 0;
}

.timeline-card p {
    font-size: 0.8125rem;
    color: #6b7280;
    margin: 0 0 0.5rem 0;
}

.timeline-card small {
    font-size: 0.75rem;
    color: #9ca3af;
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

/* Alert Boxes */
.alert-modern {
    border-radius: 10px;
    border: 1.5px solid;
    padding: 0.875rem 1rem;
    margin-bottom: 1.25rem;
    display: flex;
    align-items: start;
    gap: 0.875rem;
}

.alert-modern-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
}

.alert-modern.warning {
    background: #fffbeb;
    border-color: #fef3c7;
}

.alert-modern.warning .alert-modern-icon {
    background: #fef3c7;
    color: #92400e;
}

.alert-modern.success {
    background: #f0fdf4;
    border-color: #dcfce7;
}

.alert-modern.success .alert-modern-icon {
    background: #dcfce7;
    color: #166534;
}

.alert-modern.danger {
    background: #fef2f2;
    border-color: #fee2e2;
}

.alert-modern.danger .alert-modern-icon {
    background: #fee2e2;
    color: #991b1b;
}

.alert-modern-content h6 {
    font-size: 0.9375rem;
    font-weight: 600;
    color: #111827;
    margin: 0 0 0.25rem 0;
}

.alert-modern-content p {
    font-size: 0.8125rem;
    color: #6b7280;
    margin: 0;
}

/* Action Buttons */
.action-btn-group {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

/* Ensure buttons don't overflow */
.modern-card-body .btn {
    white-space: nowrap;
}

.modern-card-body .d-grid {
    width: 100%;
}

.modern-card-body .d-grid .btn {
    width: 100%;
    justify-content: center;
}

/* Toast Notifications */
.toast {
    min-width: 300px;
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    backdrop-filter: blur(10px);
}

.toast .toast-body {
    padding: 1rem 1.25rem;
    font-size: 0.9375rem;
    font-weight: 500;
}

.toast.bg-success {
    background: linear-gradient(135deg, #10b981, #059669) !important;
}

.toast.bg-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626) !important;
}

.toast.bg-primary {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)) !important;
}

/* Modal Enhancements */
.modal-content {
    border: none;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
}

.modal-header {
    padding: 1.25rem 1.5rem;
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1rem 1.5rem;
}

.missing-doc-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0;
    border-bottom: 1px solid #f3f4f6;
}

.missing-doc-item:last-child {
    border-bottom: none;
}

.missing-doc-item i {
    color: #ef4444;
    font-size: 0.875rem;
}

/* Responsive */
@media (max-width: 992px) {
    .doc-item {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .doc-item-left {
        width: 100%;
    }
    
    .doc-actions {
        width: 100%;
        justify-content: flex-start;
    }
}

@media (max-width: 768px) {
    .detail-info-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
    }
    
    .status-banner {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .status-banner-left {
        width: 100%;
    }
    
    .member-details {
        grid-template-columns: 1fr;
    }
}
</style>

<!-- Status Banner -->
<div class="status-banner">
    <div class="status-banner-left">
        <div class="status-icon-large" style="background: {% if application.status == 'APPROVED' %}#dcfce7; color: #166534{% elif application.status == 'REJECTED' %}#fee2e2; color: #991b1b{% elif application.status == 'UNDER_REVIEW' %}#dbeafe; color: #1e40af{% else %}#fef3c7; color: #92400e{% endif %};">
            <i class="fas {% if application.status == 'APPROVED' %}fa-check-circle{% elif application.status == 'REJECTED' %}fa-times-circle{% elif application.status == 'UNDER_REVIEW' %}fa-eye{% else %}fa-clock{% endif %}"></i>
        </div>
        <div class="status-content">
            <h3>{{ application.tracking_code }}</h3>
            <p>
                <i class="fas fa-calendar me-1"></i>
                Submitted {{ application.created_at|date:"F d, Y" }}
                {% if application.updated_at %}
                 â€¢ Updated {{ application.updated_at|timesince }} ago
                {% endif %}
            </p>
        </div>
    </div>
    <div>
        <span class="status-badge-xl {% if application.status == 'APPROVED' %}approved{% elif application.status == 'REJECTED' %}rejected{% elif application.status == 'UNDER_REVIEW' %}review{% else %}pending{% endif %}">
            {{ application.get_status_display }}
        </span>
    </div>
</div>

<!-- Alerts -->
{% if not all_documents_uploaded %}
<div class="alert-modern warning">
    <div class="alert-modern-icon">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    <div class="alert-modern-content flex-grow-1">
        <h6>Missing Documents</h6>
        <p>{{ missing_documents|length }} document(s) still need to be uploaded before this application can be approved.</p>
    </div>
</div>
{% elif has_unverified_documents %}
<div class="alert-modern warning">
    <div class="alert-modern-icon">
        <i class="fas fa-shield-alt"></i>
    </div>
    <div class="alert-modern-content flex-grow-1">
        <h6>Documents Pending Verification</h6>
        <p>Some documents have been uploaded but not yet verified. Please review and verify all documents.</p>
    </div>
</div>
{% elif all_documents_verified and application.status == 'UNDER_REVIEW' %}
<div class="alert-modern success">
    <div class="alert-modern-icon">
        <i class="fas fa-check-circle"></i>
    </div>
    <div class="alert-modern-content flex-grow-1">
        <h6>Ready for Approval</h6>
        <p>All documents have been uploaded and verified. This application is ready for final approval.</p>
    </div>
</div>
{% endif %}

<!-- Main Content Grid -->
<div class="row">
    <!-- Left Column -->
    <div class="col-lg-8">
        <!-- Business Information -->
        <div class="modern-info-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-building text-primary"></i>
                    Business Information
                </h5>
            </div>
            <div class="modern-card-body">
                <div class="detail-info-row">
                    <div class="detail-label">Business Name</div>
                    <div class="detail-value"><strong>{{ application.business_name }}</strong></div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">Business Type</div>
                    <div class="detail-value">{{ application.get_business_type_display }}</div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">Registration Number</div>
                    <div class="detail-value">{{ application.registration_number|default:"Not Provided" }}</div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">TIN Number</div>
                    <div class="detail-value">{{ application.tin_number|default:"Not Provided" }}</div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">Email</div>
                    <div class="detail-value">
                        <a href="mailto:{{ application.email }}" style="color: var(--primary-color); text-decoration: none;">
                            {{ application.email }}
                        </a>
                    </div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">Telephone</div>
                    <div class="detail-value">{{ application.telephone }}</div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">Physical Address</div>
                    <div class="detail-value">{{ application.physical_address }}</div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">City / Region</div>
                    <div class="detail-value">{{ application.city }}, {{ application.region.name|default:"Not Specified" }}</div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">Country</div>
                    <div class="detail-value">{{ application.country }}</div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">Warehouse Location</div>
                    <div class="detail-value">{{ application.warehouse_location }}</div>
                </div>
            </div>
        </div>

        <!-- Commodities -->
        <div class="modern-info-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-boxes text-success"></i>
                    Commodities to Supply
                    {% if application.commodities_to_supply.exists %}
                    <span class="badge bg-primary">{{ application.commodities_to_supply.count }}</span>
                    {% endif %}
                </h5>
            </div>
            <div class="modern-card-body">
                {% if application.commodities_to_supply.exists %}
                <div class="commodity-badge-list">
                    {% for commodity in application.commodities_to_supply.all %}
                    <div class="commodity-badge">
                        <i class="fas fa-check-circle"></i>
                        {{ commodity.name }}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-boxes fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-0">No commodities selected</p>
                </div>
                {% endif %}
                
                {% if application.other_commodities %}
                <div class="mt-3 pt-3" style="border-top: 1px solid #e5e7eb;">
                    <div class="detail-label mb-2">Additional Commodities</div>
                    <div class="detail-value">{{ application.other_commodities }}</div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Team Members -->
        {% if team_members %}
        <div class="modern-info-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-users text-info"></i>
                    Contact Persons / Team Members
                    <span class="badge bg-primary">{{ team_members|length }}</span>
                </h5>
            </div>
            <div class="modern-card-body">
                {% for member in team_members %}
                <div class="member-card">
                    <div class="member-header">
                        <div class="member-avatar">{{ member.full_name|first|upper }}</div>
                        <div class="member-info flex-grow-1">
                            <h6>{{ member.full_name }}</h6>
                            <small><i class="fas fa-briefcase me-1"></i>{{ member.position|default:"Team Member" }}</small>
                        </div>
                    </div>
                    <div class="member-details">
                        <div class="member-detail-item">
                            <div class="member-detail-label">Email</div>
                            <div class="member-detail-value">{{ member.email }}</div>
                        </div>
                        <div class="member-detail-item">
                            <div class="member-detail-label">Telephone</div>
                            <div class="member-detail-value">{{ member.telephone }}</div>
                        </div>
                        <div class="member-detail-item">
                            <div class="member-detail-label">Experience</div>
                            <div class="member-detail-value">{{ member.years_experience|default:"N/A" }} years</div>
                        </div>
                        <div class="member-detail-item">
                            <div class="member-detail-label">ID Type</div>
                            <div class="member-detail-value">{{ member.get_id_card_type_display }}</div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <div class="member-detail-label">Address</div>
                        <div class="member-detail-value">{{ member.address }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Bank Accounts -->
        {% if bank_accounts %}
        <div class="modern-info-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-university text-success"></i>
                    Bank Account Details
                    <span class="badge bg-primary">{{ bank_accounts|length }}</span>
                </h5>
            </div>
            <div class="modern-card-body">
                {% for account in bank_accounts %}
                <div class="member-card">
                    <div class="member-details">
                        <div class="member-detail-item">
                            <div class="member-detail-label">Bank Name</div>
                            <div class="member-detail-value">{{ account.bank_name }}</div>
                        </div>
                        <div class="member-detail-item">
                            <div class="member-detail-label">Branch</div>
                            <div class="member-detail-value">{{ account.branch }}</div>
                        </div>
                        <div class="member-detail-item">
                            <div class="member-detail-label">Account Name</div>
                            <div class="member-detail-value">{{ account.account_name }}</div>
                        </div>
                        <div class="member-detail-item">
                            <div class="member-detail-label">Account Number</div>
                            <div class="member-detail-value" style="font-family: monospace; font-weight: 700;">{{ account.account_number }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Next of Kin -->
        {% if next_of_kin %}
        <div class="modern-info-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-user-friends text-warning"></i>
                    Next of Kin
                    <span class="badge bg-primary">{{ next_of_kin|length }}</span>
                </h5>
            </div>
            <div class="modern-card-body">
                {% for kin in next_of_kin %}
                <div class="member-card">
                    <div class="member-header">
                        <div class="member-avatar" style="background: linear-gradient(135deg, #10b981, #059669);">
                            {{ kin.full_name|first|upper }}
                        </div>
                        <div class="member-info flex-grow-1">
                            <h6>{{ kin.full_name }}</h6>
                            <small><i class="fas fa-heart me-1"></i>{{ kin.relationship }}</small>
                        </div>
                    </div>
                    <div class="member-details">
                        <div class="member-detail-item">
                            <div class="member-detail-label">Mobile</div>
                            <div class="member-detail-value">{{ kin.mobile }}</div>
                        </div>
                        <div class="member-detail-item">
                            <div class="member-detail-label">Email</div>
                            <div class="member-detail-value">{{ kin.email|default:"Not Provided" }}</div>
                        </div>
                        <div class="member-detail-item">
                            <div class="member-detail-label">ID Type</div>
                            <div class="member-detail-value">{{ kin.get_id_card_type_display }}</div>
                        </div>
                        <div class="member-detail-item">
                            <div class="member-detail-label">ID Number</div>
                            <div class="member-detail-value" style="font-family: monospace;">{{ kin.id_card_number }}</div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <div class="member-detail-label">Address</div>
                        <div class="member-detail-value">{{ kin.address }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Declaration -->
        <div class="modern-info-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-file-signature text-primary"></i>
                    Declaration & Signature
                </h5>
            </div>
            <div class="modern-card-body">
                <div class="detail-info-row">
                    <div class="detail-label">Declaration Agreed</div>
                    <div class="detail-value">
                        {% if application.declaration_agreed %}
                            <span class="badge bg-success"><i class="fas fa-check me-1"></i>Yes</span>
                        {% else %}
                            <span class="badge bg-danger"><i class="fas fa-times me-1"></i>No</span>
                        {% endif %}
                    </div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">Data Consent</div>
                    <div class="detail-value">
                        {% if application.data_consent %}
                            <span class="badge bg-success"><i class="fas fa-check me-1"></i>Given</span>
                        {% else %}
                            <span class="badge bg-danger"><i class="fas fa-times me-1"></i>Not Given</span>
                        {% endif %}
                    </div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">Signer Name</div>
                    <div class="detail-value">{{ application.signer_name|default:"Not Provided" }}</div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">Designation</div>
                    <div class="detail-value">{{ application.signer_designation|default:"Not Provided" }}</div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">Signed At</div>
                    <div class="detail-value">
                        {% if application.signed_at %}
                            <i class="fas fa-calendar-check me-1 text-success"></i>
                            {{ application.signed_at|date:"F d, Y at h:i A" }}
                        {% else %}
                            <span class="text-muted">Not Signed</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-4">
        <!-- Quick Info -->
        <div class="modern-info-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-info-circle text-info"></i>
                    Application Summary
                </h5>
            </div>
            <div class="modern-card-body">
                <div class="detail-info-row">
                    <div class="detail-label">Reference</div>
                    <div class="detail-value" style="font-family: monospace; font-weight: 700;">{{ application.tracking_code }}</div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">Status</div>
                    <div class="detail-value">
                        <span class="status-badge-xl {% if application.status == 'APPROVED' %}approved{% elif application.status == 'REJECTED' %}rejected{% elif application.status == 'UNDER_REVIEW' %}review{% else %}pending{% endif %}" style="padding: 0.5rem 1rem; font-size: 0.75rem;">
                            {{ application.get_status_display }}
                        </span>
                    </div>
                </div>
                <div class="detail-info-row">
                    <div class="detail-label">Created</div>
                    <div class="detail-value">{{ application.created_at|date:"F d, Y" }}</div>
                </div>
                {% if application.submitted_at %}
                <div class="detail-info-row">
                    <div class="detail-label">Submitted</div>
                    <div class="detail-value">{{ application.submitted_at|date:"F d, Y" }}</div>
                </div>
                {% endif %}
                {% if application.reviewed_at %}
                <div class="detail-info-row">
                    <div class="detail-label">Reviewed</div>
                    <div class="detail-value">{{ application.reviewed_at|date:"F d, Y" }}</div>
                </div>
                {% endif %}
                {% if application.decided_at %}
                <div class="detail-info-row">
                    <div class="detail-label">Decision Date</div>
                    <div class="detail-value">{{ application.decided_at|date:"F d, Y" }}</div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Documents Status -->
        <div class="modern-info-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-file-alt text-warning"></i>
                    Documents Status
                </h5>
            </div>
            <div class="modern-card-body">
                {% if document_status %}
                {% for doc in document_status %}
                <div class="doc-item">
                    <div class="doc-item-left">
                        {% if doc.is_uploaded and doc.uploaded_doc.file %}
                            {% with file_ext=doc.uploaded_doc.file.name|slice:"-4:"|lower %}
                                {% if file_ext == ".pdf" or file_ext == "pdf" %}
                                    <div class="doc-item-icon" style="background: #fee2e2; color: #dc3545;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                                            <path d="M4.603 14.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.482-.645 19.697 19.697 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.65-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.188-.012.396-.047.614-.084.51-.27 1.134-.52 1.794a10.954 10.954 0 0 0 .98 1.686 5.753 5.753 0 0 1 1.334.05c.364.066.734.195.96.465.12.144.193.32.2.518.007.192-.047.382-.138.563a1.04 1.04 0 0 1-.354.416.856.856 0 0 1-.51.138c-.331-.014-.654-.196-.933-.417a5.712 5.712 0 0 1-.911-.95 11.651 11.651 0 0 0-1.997.406 11.307 11.307 0 0 1-1.02 1.51c-.292.35-.609.656-.927.787a.793.793 0 0 1-.58.029zm1.379-1.901c-.166.076-.32.156-.459.238-.328.194-.541.383-.647.547-.094.145-.096.25-.04.361.01.022.02.036.026.044a.266.266 0 0 0 .035-.012c.137-.056.355-.235.635-.572a8.18 8.18 0 0 0 .45-.606zm1.64-1.33a12.71 12.71 0 0 1 1.01-.193 11.744 11.744 0 0 1-.51-.858 20.801 20.801 0 0 1-.5 1.05zm2.446.45c.15.163.296.3.435.41.24.19.407.253.498.256a.107.107 0 0 0 .07-.015.307.307 0 0 0 .094-.125.436.436 0 0 0 .059-.2.095.095 0 0 0-.026-.063c-.052-.062-.2-.152-.518-.209a3.876 3.876 0 0 0-.612-.053zM8.078 7.8a6.7 6.7 0 0 0 .2-.828c.031-.188.043-.343.038-.465a.613.613 0 0 0-.032-.198.517.517 0 0 0-.145.04c-.087.035-.158.106-.196.283-.04.192-.03.469.046.822.024.111.054.227.09.346z"/>
                                        </svg>
                                    </div>
                                {% elif file_ext == ".png" or file_ext == ".jpg" or file_ext == "jpeg" %}
                                    <div class="doc-item-icon" style="background: #e0f2fe; color: #0369a1;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                            <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                                        </svg>
                                    </div>
                                {% else %}
                                    <div class="doc-item-icon" style="background: #f3f4f6; color: #6b7280;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
                                        </svg>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <div class="doc-item-icon" style="background: {% if doc.is_verified %}#dcfce7; color: #166534{% elif doc.is_uploaded %}#dbeafe; color: #1e40af{% else %}#fee2e2; color: #991b1b{% endif %};">
                                <i class="fas {% if doc.is_verified %}fa-check-circle{% elif doc.is_uploaded %}fa-file-upload{% else %}fa-times-circle{% endif %}"></i>
                            </div>
                        {% endif %}
                        <div class="doc-item-info">
                            <h6>{{ doc.requirement.label }}</h6>
                            <small>
                                {% if doc.is_verified %}
                                    Verified {% if doc.uploaded_doc.verified_at %}{{ doc.uploaded_doc.verified_at|timesince }} ago{% endif %}
                                {% elif doc.is_uploaded %}
                                    Uploaded {% if doc.uploaded_doc.uploaded_at %}{{ doc.uploaded_doc.uploaded_at|timesince }} ago{% endif %}
                                {% else %}
                                    Not yet uploaded
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    <div class="doc-actions">
                        {% if doc.is_verified %}
                            <span class="doc-status-pill verified"><i class="fas fa-shield-check"></i> Verified</span>
                            {% if doc.uploaded_doc.file %}
                            <a href="{{ doc.uploaded_doc.file.url }}" class="btn btn-sm btn-outline-primary" target="_blank" title="View Document"><i class="fas fa-eye"></i></a>
                            <a href="{{ doc.uploaded_doc.file.url }}" class="btn btn-sm btn-outline-secondary" download title="Download"><i class="fas fa-download"></i></a>
                            {% endif %}
                        {% elif doc.is_uploaded %}
                            <span class="doc-status-pill uploaded"><i class="fas fa-clock"></i> Pending</span>
                            {% if doc.uploaded_doc.file %}
                            <a href="{{ doc.uploaded_doc.file.url }}" class="btn btn-sm btn-outline-primary" target="_blank" title="View Document"><i class="fas fa-eye"></i></a>
                            <a href="{{ doc.uploaded_doc.file.url }}" class="btn btn-sm btn-outline-secondary" download title="Download"><i class="fas fa-download"></i></a>
                            <button class="btn btn-sm btn-outline-success" onclick="verifyDocument('{{ doc.requirement.code }}', '{{ application.pk }}', '{{ doc.requirement.label }}')" title="Verify Document"><i class="fas fa-check"></i></button>
                            {% endif %}
                        {% else %}
                            <span class="doc-status-pill missing"><i class="fas fa-exclamation"></i> Missing</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-file-alt fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-0">No document requirements</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Timeline -->
        {% if timeline_events %}
        <div class="modern-info-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-history text-secondary"></i>
                    Activity Timeline
                </h5>
            </div>
            <div class="modern-card-body">
                <div class="timeline-enhanced">
                    {% for event in timeline_events %}
                    <div class="timeline-item-enhanced">
                        <div class="timeline-dot" style="background: {% if event.color == 'success' %}#dcfce7; color: #166534{% elif event.color == 'danger' %}#fee2e2; color: #991b1b{% elif event.color == 'primary' %}#dbeafe; color: #1e40af{% else %}#fef3c7; color: #92400e{% endif %};">
                            <i class="{{ event.icon|default:'fas fa-info-circle' }}"></i>
                        </div>
                        <div class="timeline-card">
                            <h6>{{ event.title|default:event.type|title }}</h6>
                            <p>{{ event.description|default:"No description" }}</p>
                            <small>
                                <i class="fas fa-calendar me-1"></i>
                                {{ event.timestamp|date:"F d, Y" }} at {{ event.timestamp|time:"h:i A" }}
                                {% if event.user %}
                                â€¢ by {{ event.user.get_full_name|default:event.user.username }}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Reviewer Comment -->
        {% if application.reviewer_comment %}
        <div class="modern-info-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-comment-dots text-primary"></i>
                    Reviewer's Comments
                </h5>
            </div>
            <div class="modern-card-body">
                <div style="background: #f9fafb; border-left: 3px solid var(--primary-color); padding: 1rem 1.25rem; border-radius: 6px;">
                    <p style="margin: 0; white-space: pre-wrap; color: #374151; line-height: 1.6;">{{ application.reviewer_comment }}</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="approveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 12px; border: none;">
            <div class="modal-header" style="border-bottom: 1px solid #e5e7eb;">
                <h5 class="modal-title" style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 40px; height: 40px; background: #dcfce7; color: #166534; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    Approve Application
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p style="font-size: 0.9375rem; color: #374151;">Are you sure you want to approve this application?</p>
                <p style="font-size: 0.875rem; color: #6b7280;">This will change the status to "Approved" and notify the supplier via email.</p>
                
                <div class="mt-3">
                    <label class="form-label" style="font-weight: 600;">Comments (Optional)</label>
                    <textarea class="form-control" rows="3" id="approveComment" placeholder="Add any notes or comments..."></textarea>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 1rem 1.5rem;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="approveBtn" class="btn btn-success" onclick="confirmApprove()">
                    <i class="fas fa-check me-2"></i>Confirm Approval
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 12px; border: none;">
            <div class="modal-header" style="border-bottom: 1px solid #e5e7eb;">
                <h5 class="modal-title" style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 40px; height: 40px; background: #fee2e2; color: #991b1b; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    Reject Application
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p style="font-size: 0.9375rem; color: #374151;">Are you sure you want to reject this application?</p>
                <p style="font-size: 0.875rem; color: #6b7280;">This action will notify the supplier with your reason for rejection.</p>
                
                <div class="mt-3">
                    <label class="form-label" style="font-weight: 600;">Reason for Rejection *</label>
                    <textarea class="form-control" rows="4" id="rejectReason" placeholder="Please provide a detailed reason for rejection..." required></textarea>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 1rem 1.5rem;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="rejectBtn" class="btn btn-danger" onclick="confirmReject()">
                    <i class="fas fa-times me-2"></i>Confirm Rejection
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="verifyDocumentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 12px; border: none;">
            <div class="modal-header" style="border-bottom: 1px solid #e5e7eb;">
                <h5 class="modal-title" style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 40px; height: 40px; background: #dcfce7; color: #166534; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-shield-check"></i>
                    </div>
                    Verify Document
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div class="mb-3">
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <i class="fas fa-file-alt text-primary"></i>
                            <strong id="verifyDocName" style="color: #111827;">Document Name</strong>
                        </div>
                        <small class="text-muted">Uploaded by supplier for verification</small>
                    </div>
                </div>
                
                <p style="font-size: 0.9375rem; color: #374151;">Are you sure you want to verify this document?</p>
                <p style="font-size: 0.875rem; color: #6b7280;">This confirms that the document is valid, authentic, and meets all requirements.</p>
                
                <div class="mt-3">
                    <label class="form-label" style="font-weight: 600;">Verification Notes (Optional)</label>
                    <textarea class="form-control" rows="3" id="verifyNotes" placeholder="Add any verification notes or comments..."></textarea>
                </div>
                
                <input type="hidden" id="verifyDocType">
                <input type="hidden" id="verifyAppId">
            </div>
            <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 1rem 1.5rem;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="confirmVerifyDocument()">
                    <i class="fas fa-shield-check me-2"></i>Confirm Verification
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="requestDocsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="border-radius: 12px; border: none;">
            <div class="modal-header" style="border-bottom: 1px solid #e5e7eb;">
                <h5 class="modal-title" style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 40px; height: 40px; background: #fef3c7; color: #92400e; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-file-upload"></i>
                    </div>
                    Request Missing Documents
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div class="alert alert-warning mb-3" style="border-radius: 8px;">
                    <div class="d-flex align-items-start gap-2">
                        <i class="fas fa-info-circle mt-1"></i>
                        <div>
                            <strong>Supplier will be notified</strong>
                            <p class="mb-0 small mt-1">An email will be sent to {{ application.email }} requesting the missing documents listed below.</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label" style="font-weight: 600;">
                        Missing Documents 
                        {% if missing_documents %}
                        <span class="badge bg-danger">{{ missing_documents|length }}</span>
                        {% endif %}
                    </label>
                    <div id="missingDocsList" style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; max-height: 250px; overflow-y: auto;">
                        {% if missing_documents %}
                        <div class="list-group list-group-flush">
                            {% for doc in missing_documents %}
                            <div class="missing-doc-item">
                                <i class="fas fa-exclamation-circle"></i>
                                <strong style="color: #111827;">{{ doc.name }}</strong>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-check-circle text-success fa-2x mb-2"></i>
                            <p class="text-muted mb-0">All documents uploaded</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label" style="font-weight: 600;">Custom Message to Supplier</label>
                    <textarea class="form-control" rows="5" id="requestDocsMessage" placeholder="Add a custom message to the supplier...">Dear {{ application.business_name }},

We are reviewing your application ({{ application.tracking_code }}) and noticed that some required documents are still missing.

Please upload the documents listed above at your earliest convenience to proceed with your application.

If you have any questions, please don't hesitate to contact us.

Best regards,
GCX Admin Team</textarea>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="sendEmailCopy" checked>
                    <label class="form-check-label" for="sendEmailCopy">
                        Send me a copy of this email
                    </label>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 1rem 1.5rem;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="requestDocsBtn" class="btn btn-warning" onclick="confirmRequestDocuments()">
                    <i class="fas fa-paper-plane me-2"></i>Send Request
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>
                <span id="successToastMessage">Operation successful</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    
    <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span id="errorToastMessage">An error occurred</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    
    <div id="infoToast" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-info-circle me-2"></i>
                <span id="infoToastMessage">Information</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

{% endblock %}

{% block extrajs %}
<script>
// Toast notification functions
function showSuccessToast(message) {
    const toastElement = document.getElementById('successToast');
    document.getElementById('successToastMessage').textContent = message;
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();
}

function showErrorToast(message) {
    const toastElement = document.getElementById('errorToast');
    document.getElementById('errorToastMessage').textContent = message;
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();
}

function showInfoToast(message) {
    const toastElement = document.getElementById('infoToast');
    document.getElementById('infoToastMessage').textContent = message;
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();
}

function confirmApprove() {
    const comment = document.getElementById('approveComment').value;
    const csrfToken = document.querySelector('#csrf-form input[name="csrfmiddlewaretoken"]').value;
    
    // Get the button and disable it to prevent multiple clicks
    const approveBtn = document.getElementById('approveBtn');
    const originalHtml = approveBtn.innerHTML;
    approveBtn.disabled = true;
    approveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Approving...';
    
    fetch('{% url "applications:backoffice-approve-application" application.pk %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ comment: comment })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('approveModal')).hide();
            showSuccessToast('Application approved successfully!');
            setTimeout(() => location.reload(), 1500);
        } else {
            showErrorToast(data.message || 'Failed to approve application');
            approveBtn.disabled = false;
            approveBtn.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('An error occurred while approving the application');
        approveBtn.disabled = false;
        approveBtn.innerHTML = originalHtml;
    });
}

function confirmReject() {
    const reason = document.getElementById('rejectReason').value;
    
    if (!reason.trim()) {
        alert('Please provide a reason for rejection');
        document.getElementById('rejectReason').focus();
        return;
    }
    
    const csrfToken = document.querySelector('#csrf-form input[name="csrfmiddlewaretoken"]').value;
    
    // Get the button and disable it to prevent multiple clicks
    const rejectBtn = document.getElementById('rejectBtn');
    const originalHtml = rejectBtn.innerHTML;
    rejectBtn.disabled = true;
    rejectBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Rejecting...';
    
    fetch('{% url "applications:backoffice-reject-application" application.pk %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ reason: reason })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('rejectModal')).hide();
            showSuccessToast('Application rejected successfully');
            setTimeout(() => location.reload(), 1500);
        } else {
            showErrorToast(data.message || 'Failed to reject application');
            rejectBtn.disabled = false;
            rejectBtn.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('An error occurred while rejecting the application');
        rejectBtn.disabled = false;
        rejectBtn.innerHTML = originalHtml;
    });
}

function requestDocuments() {
    // Show the request documents modal
    const modal = new bootstrap.Modal(document.getElementById('requestDocsModal'));
    modal.show();
}

function confirmRequestDocuments() {
    const message = document.getElementById('requestDocsMessage').value;
    const sendCopy = document.getElementById('sendEmailCopy').checked;
    const csrfToken = document.querySelector('#csrf-form input[name="csrfmiddlewaretoken"]').value;
    
    if (!message.trim()) {
        showErrorToast('Please enter a message to send to the supplier');
        return;
    }
    
    // Disable button to prevent double clicks
    const confirmBtn = document.getElementById('requestDocsBtn');
    const originalHtml = confirmBtn.innerHTML;
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
    
    fetch('{% url "applications:backoffice-request-documents" application.pk %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ 
            message: message,
            send_copy: sendCopy
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('requestDocsModal')).hide();
            showSuccessToast('Document request sent successfully! ðŸ“§');
            setTimeout(() => location.reload(), 1500);
        } else {
            showErrorToast(data.message || 'Failed to send request');
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('An error occurred while sending the request');
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = originalHtml;
    });
}

function verifyDocument(docType, appId, docName) {
    // Set hidden fields and document name
    document.getElementById('verifyDocType').value = docType;
    document.getElementById('verifyAppId').value = appId;
    document.getElementById('verifyDocName').textContent = docName || 'Document';
    document.getElementById('verifyNotes').value = '';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('verifyDocumentModal'));
    modal.show();
}

function confirmVerifyDocument() {
    const docType = document.getElementById('verifyDocType').value;
    const appId = document.getElementById('verifyAppId').value;
    const notes = document.getElementById('verifyNotes').value;
    const csrfToken = document.querySelector('#csrf-form input[name="csrfmiddlewaretoken"]').value;
    
    // Disable button to prevent double clicks
    const confirmBtn = event.target;
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verifying...';
    
    fetch('{% url "applications:backoffice-verify-document" application.pk %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ 
            document_type: docType,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and show success toast
            bootstrap.Modal.getInstance(document.getElementById('verifyDocumentModal')).hide();
            showSuccessToast('Document verified successfully! âœ“');
            setTimeout(() => location.reload(), 1500);
        } else {
            showErrorToast(data.message || 'Failed to verify document');
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-shield-check me-2"></i>Confirm Verification';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('An error occurred while verifying the document');
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-shield-check me-2"></i>Confirm Verification';
    });
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
