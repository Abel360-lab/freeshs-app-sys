{% extends "backoffice/base.html" %}

{% block title %}Supplier Details - {{ application.business_name }} - GCX Admin Portal{% endblock %}

{% block page_icon %}<i class="fas fa-user-tie"></i>{% endblock %}
{% block page_title %}{{ application.business_name }}{% endblock %}
{% block page_subtitle %}Supplier Management & Contract Details{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'applications:backoffice-dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'applications:backoffice-suppliers' %}">Suppliers</a></li>
        <li class="breadcrumb-item active">{{ application.business_name }}</li>
    </ol>
</nav>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    {% if application.user and not application.user.is_active %}
    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#activateAccountModal">
        <i class="fas fa-user-check"></i> Activate Account
    </button>
    {% elif application.user and application.user.is_active %}
    <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#deactivateAccountModal">
        <i class="fas fa-user-times"></i> Deactivate Account
    </button>
    {% endif %}
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#awardContractModal">
        <i class="fas fa-award"></i> Award Contract
    </button>
    <button class="btn btn-outline-primary btn-sm" onclick="exportSupplierData()">
        <i class="fas fa-download"></i> Export Data
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Supplier Status & Overview -->
<div class="row mb-4">
    <!-- Account Status Card -->
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card status-card">
            <div class="card-body text-center">
                <div class="status-icon mb-3">
                    {% if application.user and application.user.is_active %}
                        <i class="fas fa-user-check text-success"></i>
                    {% elif application.user and not application.user.is_active %}
                        <i class="fas fa-user-times text-danger"></i>
                    {% else %}
                        <i class="fas fa-user-plus text-warning"></i>
                    {% endif %}
                </div>
                <h5 class="card-title">Account Status</h5>
                <p class="card-text">
                    {% if application.user and application.user.is_active %}
                        <span class="badge bg-success fs-6">Active</span>
                    {% elif application.user and not application.user.is_active %}
                        <span class="badge bg-danger fs-6">Inactive</span>
                    {% else %}
                        <span class="badge bg-warning fs-6">No Account</span>
                    {% endif %}
                </p>
                {% if application.user %}
                    <small class="text-muted">User ID: {{ application.user.pk }}</small>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Application Status Card -->
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card status-card">
            <div class="card-body text-center">
                <div class="status-icon mb-3">
                    {% if application.status == 'APPROVED' %}
                        <i class="fas fa-check-circle text-success"></i>
                    {% elif application.status == 'REJECTED' %}
                        <i class="fas fa-times-circle text-danger"></i>
                    {% elif application.status == 'UNDER_REVIEW' %}
                        <i class="fas fa-clock text-warning"></i>
                    {% else %}
                        <i class="fas fa-hourglass-half text-info"></i>
                    {% endif %}
                </div>
                <h5 class="card-title">Application Status</h5>
                <p class="card-text">
                    <span class="badge bg-{% if application.status == 'APPROVED' %}success{% elif application.status == 'REJECTED' %}danger{% elif application.status == 'UNDER_REVIEW' %}warning{% else %}info{% endif %} fs-6">
                        {{ application.get_status_display }}
                    </span>
                </p>
                <small class="text-muted">Submitted: {{ application.submitted_at|date:"M d, Y" }}</small>
            </div>
        </div>
    </div>

    <!-- Business Performance Card -->
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card status-card">
            <div class="card-body text-center">
                <div class="status-icon mb-3">
                    <i class="fas fa-chart-line text-primary"></i>
                </div>
                <h5 class="card-title">Performance</h5>
                <div class="row text-center">
                    <div class="col-4">
                        <div class="fw-bold text-primary">{{ total_contracts }}</div>
                        <small class="text-muted">Contracts</small>
                    </div>
                    <div class="col-4">
                        <div class="fw-bold text-success">{{ total_srvs }}</div>
                        <small class="text-muted">SRVs</small>
                    </div>
                    <div class="col-4">
                        <div class="fw-bold text-info">{{ total_invoices }}</div>
                        <small class="text-muted">Invoices</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Financial Summary -->
<div class="row mb-4">
    <div class="col-lg-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-chart-line"></i>
                    Contract Value Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-muted">Total Contract Value:</span>
                    <span class="fw-bold text-primary">GHS {{ total_contract_value|floatformat:2 }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">Active Contracts:</span>
                    <span class="fw-bold text-success">{{ active_contracts }}</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-money-bill-wave"></i>
                    Invoice Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-muted">Total Invoice Amount:</span>
                    <span class="fw-bold text-primary">GHS {{ total_invoice_amount|floatformat:2 }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">Amount Paid:</span>
                    <span class="fw-bold text-success">GHS {{ total_paid_amount|floatformat:2 }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Tabs -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="supplierTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                            <i class="fas fa-info-circle me-2"></i>Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="contracts-tab" data-bs-toggle="tab" data-bs-target="#contracts" type="button" role="tab">
                            <i class="fas fa-file-contract me-2"></i>Contracts
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab">
                            <i class="fas fa-file-contract me-2"></i>Contract Documents
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices" type="button" role="tab">
                            <i class="fas fa-file-invoice me-2"></i>Invoices
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab">
                            <i class="fas fa-history me-2"></i>Activity
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="supplierTabsContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="row">
                            <!-- Business Information -->
                            <div class="col-lg-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title">
                                            <i class="fas fa-building me-2"></i>Business Information
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-sm-4"><strong>Business Name:</strong></div>
                                            <div class="col-sm-8">{{ application.business_name }}</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-4"><strong>Email:</strong></div>
                                            <div class="col-sm-8">{{ application.email }}</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-4"><strong>Phone:</strong></div>
                                            <div class="col-sm-8">{{ application.telephone }}</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-4"><strong>Address:</strong></div>
                                            <div class="col-sm-8">{{ application.physical_address }}, {{ application.city }}</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-4"><strong>Region:</strong></div>
                                            <div class="col-sm-8">{{ application.region.name|default:"--" }}</div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-4"><strong>Status:</strong></div>
                                            <div class="col-sm-8">
                                                <span class="badge bg-success">{{ application.get_status_display }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Team Members -->
                            <div class="col-lg-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title">
                                            <i class="fas fa-users me-2"></i>Team Members
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        {% if team_members %}
                                            {% for member in team_members %}
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <div>
                                                    <strong>{{ member.name }}</strong><br>
                                                    <small class="text-muted">{{ member.position }}</small>
                                                </div>
                                                <div class="text-end">
                                                    <small class="text-muted">{{ member.phone }}</small><br>
                                                    <small class="text-muted">{{ member.email }}</small>
                                                </div>
                                            </div>
                                            {% if not forloop.last %}<hr>{% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted">No team members added.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Bank Accounts -->
                            <div class="col-lg-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title">
                                            <i class="fas fa-university me-2"></i>Bank Accounts
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        {% if bank_accounts %}
                                            {% for account in bank_accounts %}
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <div>
                                                    <strong>{{ account.bank_name }}</strong><br>
                                                    <small class="text-muted">{{ account.account_name }}</small>
                                                </div>
                                                <div class="text-end">
                                                    <small class="text-muted">{{ account.account_number }}</small><br>
                                                    <small class="text-muted">{{ account.branch }}</small>
                                                </div>
                                            </div>
                                            {% if not forloop.last %}<hr>{% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted">No bank accounts added.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Next of Kin -->
                            <div class="col-lg-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title">
                                            <i class="fas fa-user-friends me-2"></i>Next of Kin
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        {% if next_of_kin %}
                                            {% for kin in next_of_kin %}
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <div>
                                                    <strong>{{ kin.name }}</strong><br>
                                                    <small class="text-muted">{{ kin.relationship }}</small>
                                                </div>
                                                <div class="text-end">
                                                    <small class="text-muted">{{ kin.phone }}</small><br>
                                                    <small class="text-muted">{{ kin.address }}</small>
                                                </div>
                                            </div>
                                            {% if not forloop.last %}<hr>{% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted">No next of kin added.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contracts Tab -->
                    <div class="tab-pane fade" id="contracts" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>Contracts ({{ total_contracts }})</h6>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadContractModal">
                                <i class="fas fa-plus"></i> Upload Contract
                            </button>
                        </div>
                        
                        {% if contracts %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Contract Number</th>
                                        <th>Title</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Value</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for contract in contracts %}
                                    <tr>
                                        <td><strong>{{ contract.contract_number }}</strong></td>
                                        <td>{{ contract.title }}</td>
                                        <td>{{ contract.get_contract_type_display }}</td>
                                        <td>
                                            <span class="badge bg-{% if contract.status == 'ACTIVE' %}success{% elif contract.status == 'DRAFT' %}warning{% elif contract.status == 'EXPIRED' %}danger{% else %}secondary{% endif %}">
                                                {{ contract.get_status_display }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if contract.contract_value %}
                                                {{ contract.currency }} {{ contract.contract_value|floatformat:2 }}
                                            {% else %}
                                                --
                                            {% endif %}
                                        </td>
                                        <td>{{ contract.start_date|date:"M d, Y" }}</td>
                                        <td>{{ contract.end_date|date:"M d, Y" }}</td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="{{ contract.contract_file.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                <button class="btn btn-sm btn-outline-success" onclick="createSRV({{ contract.pk }})">
                                                    <i class="fas fa-plus"></i> SRV
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-file-contract fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No contracts uploaded</h6>
                            <p class="text-muted">Upload the first contract to get started.</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Contract Documents Tab -->
                    <div class="tab-pane fade" id="documents" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>Contract Documents</h6>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal">
                                <i class="fas fa-plus"></i> Upload Document
                            </button>
                        </div>
                        
                        {% if contract_requirements %}
                        <div class="row">
                            {% for requirement in contract_requirements %}
                            <div class="col-lg-6 mb-4">
                                <div class="card requirement-section">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-file-contract me-2"></i>{{ requirement.label }}
                                            {% if requirement.is_required %}
                                            <span class="badge bg-danger ms-2">Required</span>
                                            {% else %}
                                            <span class="badge bg-secondary ms-2">Optional</span>
                                            {% endif %}
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text text-muted small mb-3">{{ requirement.description }}</p>
                                        
                                        {% if requirement.condition_note %}
                                        <div class="alert alert-warning alert-sm mb-3">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            <small>{{ requirement.condition_note }}</small>
                                        </div>
                                        {% endif %}
                                        
                                        {% with requirement.documents.all as docs %}
                                        {% if docs %}
                                        <div class="uploaded-documents">
                                            <h6 class="small text-muted mb-2">Uploaded Documents:</h6>
                                            {% for doc in docs %}
                                            <div class="document-item d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                                <div>
                                                    <strong class="small">{{ doc.title }}</strong>
                                                    <br>
                                                    <small class="text-muted">
                                                        v{{ doc.version }} | {{ doc.file_extension }} ({{ doc.file_size }})
                                                        {% if doc.is_current_version %}
                                                        <span class="badge bg-success ms-1">Current</span>
                                                        {% endif %}
                                                    </small>
                                                </div>
                                                <a href="{{ doc.document_file.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% else %}
                                        <div class="no-documents text-center py-3">
                                            <i class="fas fa-file-upload text-muted mb-2"></i>
                                            <p class="text-muted small mb-0">No documents uploaded for this requirement</p>
                                        </div>
                                        {% endif %}
                                        {% endwith %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-file-contract fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No contract document requirements defined</h6>
                            <p class="text-muted">Contact administrator to set up contract document requirements.</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Invoices Tab -->
                    <div class="tab-pane fade" id="invoices" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>Invoices ({{ total_invoices }})</h6>
                        </div>
                        
                        {% if invoices %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Invoice Number</th>
                                        <th>SRV</th>
                                        <th>Status</th>
                                        <th>Total Amount</th>
                                        <th>Paid Amount</th>
                                        <th>Due Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for invoice in invoices %}
                                    <tr>
                                        <td><strong>{{ invoice.invoice_number }}</strong></td>
                                        <td>{{ invoice.srv.srv_number }}</td>
                                        <td>
                                            <span class="badge bg-{% if invoice.status == 'PAID' %}success{% elif invoice.status == 'OVERDUE' %}danger{% elif invoice.status == 'SENT' %}info{% else %}warning{% endif %}">
                                                {{ invoice.get_status_display }}
                                            </span>
                                        </td>
                                        <td>{{ invoice.currency }} {{ invoice.total_amount|floatformat:2 }}</td>
                                        <td>{{ invoice.currency }} {{ invoice.paid_amount|floatformat:2 }}</td>
                                        <td>{{ invoice.due_date|date:"M d, Y" }}</td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                {% if invoice.invoice_document %}
                                                <a href="{{ invoice.invoice_document.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                {% endif %}
                                                <button class="btn btn-sm btn-outline-info" onclick="viewInvoiceDetails({{ invoice.pk }})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No invoices created</h6>
                            <p class="text-muted">Create invoices from SRVs to track payments.</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Activity Tab -->
                    <div class="tab-pane fade" id="activity" role="tabpanel">
                        <h6>Recent Activity</h6>
                        
                        {% if recent_activity %}
                        <div class="timeline">
                            {% for activity in recent_activity %}
                            <div class="timeline-item">
                                <div class="timeline-marker bg-{% if activity.type == 'contract' %}primary{% elif activity.type == 'srv' %}info{% else %}success{% endif %}"></div>
                                <div class="timeline-content">
                                    <h6 class="timeline-title">{{ activity.action }}</h6>
                                    <p class="timeline-text text-muted">{{ activity.date|date:"M d, Y H:i" }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-history fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No recent activity</h6>
                            <p class="text-muted">Activity will appear here as you manage contracts, SRVs, and invoices.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Award Contract Modal -->
<div class="modal fade" id="awardContractModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-award me-2"></i>Award Contract to {{ application.business_name }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="awardContractForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="contract_number" class="form-label">Contract Number *</label>
                            <input type="text" class="form-control" id="contract_number" name="contract_number" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="contract_type" class="form-label">Contract Type *</label>
                            <select class="form-select" id="contract_type" name="contract_type" required>
                                <option value="">Select Type</option>
                                <option value="SUPPLY_AGREEMENT">Supply Agreement</option>
                                <option value="FRAMEWORK_AGREEMENT">Framework Agreement</option>
                                <option value="SERVICE_AGREEMENT">Service Agreement</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="title" class="form-label">Contract Title *</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="start_date" class="form-label">Start Date *</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="end_date" class="form-label">End Date *</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="contract_value" class="form-label">Contract Value *</label>
                            <input type="number" class="form-control" id="contract_value" name="contract_value" step="0.01" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="currency" class="form-label">Currency</label>
                            <select class="form-select" id="currency" name="currency">
                                <option value="GHS" selected>GHS</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="contract_file" class="form-label">Contract File *</label>
                        <input type="file" class="form-control" id="contract_file" name="contract_file" accept=".pdf,.doc,.docx" required>
                        <div class="form-text">Upload the signed contract document</div>
                    </div>
                    <div class="mb-3">
                        <label for="additional_documents" class="form-label">Additional Documents</label>
                        <input type="file" class="form-control" id="additional_documents" name="additional_documents" multiple accept=".pdf,.doc,.docx">
                        <div class="form-text">Upload additional contract-specific documents (optional)</div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> This will create a new contract for {{ application.business_name }} and notify the supplier.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-award me-2"></i>Award Contract
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Upload Document Modal -->
<div class="modal fade" id="uploadDocumentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2"></i>Upload Contract Documents
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="uploadDocumentForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Instructions:</strong> Upload the required contract documents. Each document type has specific file size and format requirements.
                    </div>
                    
                    <div class="row">
                        {% for requirement in contract_requirements %}
                        <div class="col-md-6 mb-4">
                            <div class="card requirement-card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        {{ requirement.label }}
                                        {% if requirement.is_required %}
                                        <span class="badge bg-danger ms-2">Required</span>
                                        {% else %}
                                        <span class="badge bg-secondary ms-2">Optional</span>
                                        {% endif %}
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <p class="card-text small text-muted">{{ requirement.description }}</p>
                                    {% if requirement.condition_note %}
                                    <p class="card-text small text-warning">
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ requirement.condition_note }}
                                    </p>
                                    {% endif %}
                                    <div class="mb-3">
                                        <label for="document_{{ requirement.code }}" class="form-label">
                                            Upload File
                                        </label>
                                        <input type="file" 
                                               class="form-control" 
                                               id="document_{{ requirement.code }}" 
                                               name="document_{{ requirement.code }}"
                                               accept="{% for ext in requirement.get_allowed_extensions %}{{ ext }}{% if not forloop.last %},{% endif %}{% endfor %}"
                                               data-max-size="{{ requirement.max_file_size_mb }}"
                                               {% if requirement.is_required %}required{% endif %}>
                                        <div class="form-text">
                                            <small>
                                                <i class="fas fa-file me-1"></i>
                                                Allowed: {% for ext in requirement.get_allowed_extensions %}{{ ext }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                                | Max size: {{ requirement.max_file_size_mb }}MB
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>Upload Documents
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Invoice Modal -->
<div class="modal fade" id="createInvoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Invoice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createInvoiceForm" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" id="invoice_srv_id" name="srv_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="invoice_number" class="form-label">Invoice Number *</label>
                            <input type="text" class="form-control" id="invoice_number" name="invoice_number" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="invoice_date" class="form-label">Invoice Date *</label>
                            <input type="date" class="form-control" id="invoice_date" name="invoice_date" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="due_date" class="form-label">Due Date *</label>
                            <input type="date" class="form-control" id="due_date" name="due_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="payment_terms" class="form-label">Payment Terms</label>
                            <select class="form-select" id="payment_terms" name="payment_terms">
                                <option value="NET_15">Net 15</option>
                                <option value="NET_30" selected>Net 30</option>
                                <option value="NET_45">Net 45</option>
                                <option value="NET_60">Net 60</option>
                                <option value="IMMEDIATE">Immediate</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="subtotal" class="form-label">Subtotal *</label>
                            <input type="number" class="form-control" id="subtotal" name="subtotal" step="0.01" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tax_rate" class="form-label">Tax Rate (%)</label>
                            <input type="number" class="form-control" id="tax_rate" name="tax_rate" step="0.01" value="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="invoice_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="invoice_notes" name="notes" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="invoice_document" class="form-label">Invoice Document</label>
                        <input type="file" class="form-control" id="invoice_document" name="invoice_document" accept=".pdf,.doc,.docx">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Invoice</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Activate Account Modal -->
<div class="modal fade" id="activateAccountModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 12px; border: none;">
            <div class="modal-header" style="border-bottom: 1px solid #e5e7eb;">
                <h5 class="modal-title" style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 40px; height: 40px; background: #dcfce7; color: #166534; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user-check"></i>
                    </div>
                    Activate Supplier Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div class="alert alert-success" style="border-radius: 8px;">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Action Required:</strong> Activating this account will grant the supplier full access to the system.
                </div>
                
                <div class="mb-3">
                    <h6 class="mb-2">Supplier Details:</h6>
                    <div class="bg-light p-3 rounded">
                        <div class="mb-2">
                            <strong>Business Name:</strong> {{ application.business_name }}
                        </div>
                        <div class="mb-2">
                            <strong>Email:</strong> {{ application.email }}
                        </div>
                        {% if application.user %}
                        <div>
                            <strong>User ID:</strong> {{ application.user.pk }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label" style="font-weight: 600;">Activation Notes (Optional)</label>
                    <textarea class="form-control" rows="3" id="activationNotes" placeholder="Add any notes about this activation..."></textarea>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="sendActivationEmail" checked>
                    <label class="form-check-label" for="sendActivationEmail">
                        Send activation notification email to supplier
                    </label>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 1rem 1.5rem;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmActivateBtn" class="btn btn-success" onclick="confirmActivateAccount()">
                    <i class="fas fa-check me-2"></i>Confirm Activation
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Deactivate Account Modal -->
<div class="modal fade" id="deactivateAccountModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 12px; border: none;">
            <div class="modal-header" style="border-bottom: 1px solid #e5e7eb;">
                <h5 class="modal-title" style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 40px; height: 40px; background: #fee2e2; color: #991b1b; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user-times"></i>
                    </div>
                    Deactivate Supplier Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div class="alert alert-warning" style="border-radius: 8px;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Deactivating this account will revoke the supplier's system access immediately.
                </div>
                
                <div class="mb-3">
                    <h6 class="mb-2">Supplier Details:</h6>
                    <div class="bg-light p-3 rounded">
                        <div class="mb-2">
                            <strong>Business Name:</strong> {{ application.business_name }}
                        </div>
                        <div class="mb-2">
                            <strong>Email:</strong> {{ application.email }}
                        </div>
                        {% if application.user %}
                        <div>
                            <strong>User ID:</strong> {{ application.user.pk }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label" style="font-weight: 600;">Reason for Deactivation *</label>
                    <textarea class="form-control" rows="4" id="deactivationReason" placeholder="Please provide a reason for deactivating this account..." required></textarea>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="sendDeactivationEmail" checked>
                    <label class="form-check-label" for="sendDeactivationEmail">
                        Send deactivation notification email to supplier
                    </label>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 1rem 1.5rem;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmDeactivateBtn" class="btn btn-danger" onclick="confirmDeactivateAccount()">
                    <i class="fas fa-times me-2"></i>Confirm Deactivation
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>
                <span id="successToastMessage">Operation successful</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    
    <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span id="errorToastMessage">An error occurred</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<form style="display: none;" id="csrf-form">{% csrf_token %}</form>

<style>
/* Modern Status Cards */
.status-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    position: relative;
    overflow: hidden;
}

.status-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.status-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}

.status-card:hover::before {
    opacity: 1;
}

.status-icon {
    font-size: 3.5rem;
    opacity: 0.9;
}

.status-card .card-title {
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.75rem;
    font-size: 1.1rem;
    letter-spacing: -0.01em;
}

.status-card .badge {
    font-size: 1rem;
    padding: 0.6rem 1.2rem;
    font-weight: 600;
    border-radius: 8px;
    letter-spacing: 0.02em;
}

.financial-summary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.financial-summary h5 {
    color: white;
    font-weight: 600;
}

.financial-summary .value {
    font-size: 1.5rem;
    font-weight: bold;
}

.admin-actions {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.admin-actions .btn {
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

/* Modern Card Enhancements */
.card {
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}

.card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #e5e7eb;
    border-radius: 12px 12px 0 0 !important;
    padding: 1.25rem 1.5rem;
}

.card-header .card-title {
    font-weight: 600;
    color: #1e293b;
    margin: 0;
    font-size: 1.05rem;
}

.document-card {
    transition: all 0.3s ease;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
}

.document-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    border-color: #667eea;
}

.document-card .card-title {
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
}

.document-meta {
    background: #f8f9fa;
    padding: 0.5rem;
    border-radius: 4px;
    margin: 0.5rem 0;
}

.requirement-card {
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
}

.requirement-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-color: #007bff;
}

.requirement-card .card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #dee2e6;
}

.requirement-card .card-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #2c3e50;
}

.requirement-section {
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
}

.requirement-section:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.requirement-section .card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #dee2e6;
}

.requirement-section .card-title {
    font-size: 1rem;
    font-weight: 600;
    color: #2c3e50;
}

.document-item {
    transition: all 0.2s ease;
}

.document-item:hover {
    background-color: #e3f2fd !important;
    transform: translateX(2px);
}

.alert-sm {
    padding: 0.5rem 0.75rem;
    font-size: 0.8rem;
}

.timeline {
    position: relative;
    padding-left: 2rem;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 1rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 1.5rem;
}

.timeline-marker {
    position: absolute;
    left: -1.5rem;
    top: 0.25rem;
    width: 1rem;
    height: 1rem;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 0 0 3px #dee2e6;
}

.timeline-content {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.timeline-title {
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
}

.timeline-text {
    font-size: 0.75rem;
    margin: 0;
}

/* Modern Tabs Design */
.nav-tabs {
    border-bottom: 2px solid #e5e7eb;
}

.nav-tabs .nav-link {
    border: none;
    color: #64748b;
    font-weight: 500;
    padding: 1rem 1.5rem;
    transition: all 0.3s ease;
    position: relative;
}

.nav-tabs .nav-link:hover {
    color: #667eea;
    background-color: transparent;
}

.nav-tabs .nav-link.active {
    color: #667eea;
    background-color: transparent;
    border: none;
}

.nav-tabs .nav-link.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-radius: 3px 3px 0 0;
}

/* Table Enhancements */
.table {
    border-collapse: separate;
    border-spacing: 0;
}

.table thead th {
    background: #f8f9fa;
    color: #1e293b;
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 2px solid #e5e7eb;
    padding: 1rem;
}

.table tbody tr {
    transition: all 0.2s ease;
}

.table tbody tr:hover {
    background-color: #f8f9fa;
    transform: scale(1.01);
}

/* Button Enhancements */
.btn-group .btn {
    border-radius: 6px !important;
    margin-right: 0.25rem;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    border-radius: 8px;
}

/* Performance Metrics */
.status-card .row.text-center .col-4 {
    position: relative;
}

.status-card .row.text-center .col-4:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 10%;
    height: 80%;
    width: 1px;
    background: #e5e7eb;
}

.status-card .fw-bold {
    font-size: 1.5rem;
    display: block;
    margin-bottom: 0.25rem;
}

/* Alert Enhancements */
.alert {
    border-radius: 10px;
    border: none;
    padding: 1rem 1.25rem;
}

.alert-info {
    background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
    color: #0c4a6e;
}

.alert-warning {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #78350f;
}

.alert-success {
    background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
    color: #14532d;
}

/* Animation */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.status-card, .card {
    animation: fadeInUp 0.5s ease backwards;
}

.status-card:nth-child(1) { animation-delay: 0.1s; }
.status-card:nth-child(2) { animation-delay: 0.2s; }
.status-card:nth-child(3) { animation-delay: 0.3s; }
</style>
{% endblock %}

{% block extrajs %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
    
    // Initialize modals properly
    var modalElements = document.querySelectorAll('.modal');
    modalElements.forEach(function(modalEl) {
        new bootstrap.Modal(modalEl, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    });
});

// Award contract form
document.getElementById('awardContractForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Awarding...';
    submitBtn.disabled = true;
    
    fetch('{% url "applications:backoffice-award-contract" application.pk %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            bootstrap.Modal.getInstance(document.getElementById('awardContractModal')).hide();
            location.reload();
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'An error occurred while awarding the contract.');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Upload document form
document.getElementById('uploadDocumentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
    submitBtn.disabled = true;
    
    fetch('{% url "applications:backoffice-upload-document" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            bootstrap.Modal.getInstance(document.getElementById('uploadDocumentModal')).hide();
            location.reload();
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'An error occurred while uploading the document.');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Create Invoice form
document.getElementById('createInvoiceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const srvId = document.getElementById('invoice_srv_id').value;
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    submitBtn.disabled = true;
    
    fetch(`/backoffice/srvs/${srvId}/create-invoice/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            bootstrap.Modal.getInstance(document.getElementById('createInvoiceModal')).hide();
            location.reload();
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'An error occurred while creating the invoice.');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Helper functions
function createInvoice(invoiceId) {
    // TODO: Implement invoice creation
    alert('Invoice creation functionality will be implemented soon.');
}

function viewInvoiceDetails(invoiceId) {
    // TODO: Implement invoice details view
    alert('Invoice details view will be implemented soon.');
}

// Toast notification functions
function showSuccessToast(message) {
    const toastElement = document.getElementById('successToast');
    document.getElementById('successToastMessage').textContent = message;
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();
}

function showErrorToast(message) {
    const toastElement = document.getElementById('errorToast');
    document.getElementById('errorToastMessage').textContent = message;
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();
}

// Account activation functions with modal
function confirmActivateAccount() {
    {% if application.user %}
    const userId = {{ application.user.pk }};
    {% else %}
    showErrorToast('No user account found for this supplier');
    return;
    {% endif %}
    
    const notes = document.getElementById('activationNotes').value;
    const sendEmail = document.getElementById('sendActivationEmail').checked;
    const csrfToken = document.querySelector('#csrf-form input[name="csrfmiddlewaretoken"]').value;
    
    // Get button and disable it
    const activateBtn = document.getElementById('confirmActivateBtn');
    const originalHtml = activateBtn.innerHTML;
    activateBtn.disabled = true;
    activateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Activating...';
    
    fetch(`/backoffice/users/${userId}/activate/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            notes: notes,
            send_email: sendEmail
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('activateAccountModal')).hide();
            showSuccessToast('Account activated successfully! ');
            setTimeout(() => location.reload(), 1500);
        } else {
            showErrorToast(data.message || 'Failed to activate account');
            activateBtn.disabled = false;
            activateBtn.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('An error occurred while activating the account');
        activateBtn.disabled = false;
        activateBtn.innerHTML = originalHtml;
    });
}

function confirmDeactivateAccount() {
    {% if application.user %}
    const userId = {{ application.user.pk }};
    {% else %}
    showErrorToast('No user account found for this supplier');
    return;
    {% endif %}
    
    const reason = document.getElementById('deactivationReason').value;
    
    if (!reason.trim()) {
        showErrorToast('Please provide a reason for deactivation');
        document.getElementById('deactivationReason').focus();
        return;
    }
    
    const sendEmail = document.getElementById('sendDeactivationEmail').checked;
    const csrfToken = document.querySelector('#csrf-form input[name="csrfmiddlewaretoken"]').value;
    
    // Get button and disable it
    const deactivateBtn = document.getElementById('confirmDeactivateBtn');
    const originalHtml = deactivateBtn.innerHTML;
    deactivateBtn.disabled = true;
    deactivateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deactivating...';
    
    fetch(`/backoffice/users/${userId}/deactivate/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            reason: reason,
            send_email: sendEmail
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('deactivateAccountModal')).hide();
            showSuccessToast('Account deactivated successfully');
            setTimeout(() => location.reload(), 1500);
        } else {
            showErrorToast(data.message || 'Failed to deactivate account');
            deactivateBtn.disabled = false;
            deactivateBtn.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('An error occurred while deactivating the account');
        deactivateBtn.disabled = false;
        deactivateBtn.innerHTML = originalHtml;
    });
}

function exportSupplierData() {
    // TODO: Implement data export
    alert('Data export functionality will be implemented soon.');
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.content-body');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}

